<div class="container-fluid pb-5">
  <div class="page-toolbar mb-4">
    <div>
      <h2 class="page-title">Diccionario MARC</h2>
      <p class="text-muted mb-0">Consulta y actualiza los formatos, tags, subcampos e indicadores definidos en el catálogo de MARC.</p>
    </div>
  </div>

  <section class="catalog-section mb-5">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h3 class="h5 mb-1">Formatos</h3>
        <small class="text-muted">Define el formato MARC que alimenta el diccionario.</small>
      </div>
      <div class="input-group page-search w-50">
        <span class="input-group-text"><i class="fa fa-search" aria-hidden="true"></i></span>
        <input [(ngModel)]="searchFormatosField" name="searchFormatosField" (blur)="searchFormatos()" (keydown.enter)="searchFormatos()" type="text" class="form-control" placeholder="Buscar">
        <button class="btn btn-success" type="button" (click)="nuevoFormato()"><i class="fa fa-plus-circle" aria-hidden="true"></i></button>
      </div>
    </div>

    <div class="table-responsive mb-3">
      <table class="table table-sm table-hover align-middle">
        <thead>
          <tr>
            <th>Código</th>
            <th>Nombre</th>
            <th>Fuente</th>
            <th>Versión</th>
            <th>Activo</th>
            <th>Creado</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let formato of formatos | bibliotecaSearch: searchFormatosField"
              [class.selected-row]="selectedFormatoId === formato.id">
            <td>{{ formato.codigo }}</td>
            <td>{{ formato.nombre }}</td>
            <td>{{ formato.fuente || '-' }}</td>
            <td>{{ formato.version || '-' }}</td>
            <td>{{ formato.activo ? 'Sí' : 'No' }}</td>
            <td>{{ formato.creadoEl || '-' }}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-primary me-2" type="button" (click)="editarFormato(formato)">Editar</button>
              <button class="btn btn-sm btn-outline-danger" type="button" (click)="eliminarFormato(formato)">Eliminar</button>
            </td>
          </tr>
          <tr *ngIf="(formatos | bibliotecaSearch: searchFormatosField)?.length === 0">
            <td colspan="7" class="text-center text-muted">No hay formatos que coincidan</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="modal-mask" *ngIf="formatoFormVisible">
      <div class="modal-panel">
        <div class="modal-header">
          <h5 class="modal-title">{{ formatoEditing ? 'Editar formato' : 'Nuevo formato' }}</h5>
          <button type="button" class="btn-close" aria-label="Cerrar" (click)="cancelarFormato()"></button>
        </div>
        <form class="page-form">
          <div class="page-form-card mt-0">
            <div class="row g-3">
              <div class="col-12 col-md-4">
                <label class="form-label">Código</label>
                <input class="form-control" [(ngModel)]="formatoForm.codigo" name="formatoCodigo" />
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">Nombre</label>
                <input class="form-control" [(ngModel)]="formatoForm.nombre" name="formatoNombre" />
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">Fuente</label>
                <input class="form-control" [(ngModel)]="formatoForm.fuente" name="formatoFuente" />
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">Versión</label>
                <input class="form-control" [(ngModel)]="formatoForm.version" name="formatoVersion" />
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">URL de la fuente</label>
                <input class="form-control" [(ngModel)]="formatoForm.urlFuente" name="formatoUrl" />
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">Activo</label>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" [(ngModel)]="formatoForm.activo" name="formatoActivo" />
                  <label class="form-check-label">{{ formatoForm.activo ? 'Activo' : 'Inactivo' }}</label>
                </div>
              </div>
            </div>
            <div class="page-actions d-flex gap-2 mt-3">
              <button class="btn btn-success" type="button" (click)="guardarFormato()">Grabar</button>
              <button class="btn btn-outline-secondary" type="button" (click)="cancelarFormato()">Cancelar</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </section>

  <section class="catalog-section mb-5">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h3 class="h5 mb-1">Tags</h3>
        <small class="text-muted">Gestiona los tags del diccionario de campos.</small>
      </div>
      <div class="input-group page-search w-50">
        <span class="input-group-text"><i class="fa fa-search" aria-hidden="true"></i></span>
        <input [(ngModel)]="searchCamposField" name="searchCamposField" (blur)="searchCampos()" (keydown.enter)="searchCampos()" type="text" class="form-control" placeholder="Buscar">
        <button class="btn btn-success" type="button" (click)="nuevoCampo()"><i class="fa fa-plus-circle" aria-hidden="true"></i></button>
      </div>
    </div>

    <div class="table-responsive mb-3">
      <table class="table table-hover table-sm align-middle">
        <thead>
          <tr>
            <th>Tag</th>
            <th>Nombre</th>
            <th>Formato</th>
            <th>Grupo</th>
            <th>Orden</th>
            <th>Repetibilidad</th>
            <th>Control</th>
            <th>Obsoleto</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let campo of campos | bibliotecaSearch: searchCamposField"
              class="table-row-clickable"
              [class.selected-row]="selectedCampoId === campo.id"
              (click)="editarCampo(campo)">
            <td>{{ campo.tag }}</td>
            <td>{{ campo.nombre }}</td>
            <td>{{ campo.formatoNombre || '-' }}</td>
            <td>{{ campo.grupo || '-' }}</td>
            <td>{{ campo.orden ?? '-' }}</td>
            <td>{{ campo.repetibilidad || 'NR' }}</td>
            <td>{{ campo.esControl ? 'Sí' : 'No' }}</td>
            <td>{{ campo.esObsoleto ? 'Sí' : 'No' }}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-primary me-2" type="button"
                      (click)="$event.stopPropagation(); editarCampo(campo)">
                Editar
              </button>
              <button class="btn btn-sm btn-outline-danger" type="button"
                      (click)="$event.stopPropagation(); eliminarCampo(campo)">
                Eliminar
              </button>
            </td>
          </tr>
          <tr *ngIf="(campos | bibliotecaSearch: searchCamposField)?.length === 0">
            <td colspan="9" class="text-center text-muted">No hay tags que coincidan</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="modal-mask" *ngIf="campoFormVisible">
      <div class="modal-panel">
        <div class="modal-header">
          <h5 class="modal-title">{{ campoEditing ? 'Editar tag' : 'Nuevo tag' }}</h5>
          <button type="button" class="btn-close" aria-label="Cerrar" (click)="cancelarCampo()"></button>
        </div>
        <form #campoFormSection class="page-form">
          <div class="page-form-card mt-0">
            <div class="row g-3">
              <div class="col-12 col-md-4">
                <label class="form-label">Formato</label>
                <select class="form-select" [(ngModel)]="campoForm.formatoId" name="campoFormato">
                  <option [ngValue]="0">Seleccione...</option>
                  <option *ngFor="let formato of formatos" [ngValue]="formato.id">{{ formato.nombre }}</option>
                </select>
              </div>
              <div class="col-12 col-md-3">
                <label class="form-label">Tag</label>
                <input class="form-control" [(ngModel)]="campoForm.tag" name="campoTag" />
              </div>
              <div class="col-12 col-md-5">
                <label class="form-label">Nombre</label>
                <input class="form-control" [(ngModel)]="campoForm.nombre" name="campoNombre" />
              </div>
              <div class="col-12 col-md-3">
                <label class="form-label">Grupo</label>
                <input class="form-control" [(ngModel)]="campoForm.grupo" name="campoGrupo" />
              </div>
              <div class="col-12 col-md-3">
                <label class="form-label">Orden</label>
                <input class="form-control" type="number" min="1" [(ngModel)]="campoForm.orden" name="campoOrden" />
              </div>
              <div class="col-12 col-md-3">
                <label class="form-label">Repetibilidad</label>
                <select class="form-select" [(ngModel)]="campoForm.repetibilidad" name="campoRepetibilidad">
                  <option [ngValue]="undefined">NR (no repetible)</option>
                  <option *ngFor="let opcion of repetibilidadOptions" [ngValue]="opcion">{{ opcion }}</option>
                </select>
              </div>
              <div class="col-12 col-md-3 d-flex align-items-center">
                <div class="form-check me-3">
                  <input class="form-check-input" type="checkbox" [(ngModel)]="campoForm.esControl" name="campoEsControl" />
                  <label class="form-check-label">Control</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" [(ngModel)]="campoForm.esObsoleto" name="campoEsObsoleto" />
                  <label class="form-check-label">Obsoleto</label>
                </div>
              </div>
            </div>
            <div *ngIf="campoEditing" class="mt-4">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <h6 class="m-0">Subcampos del tag {{ campoForm.tag }}</h6>
                <button class="btn btn-outline-success btn-sm" type="button"
                        (click)="nuevoSubcampo(campoForm.formatoId, campoForm.tag)">
                  <i class="fa fa-plus-circle"></i> Agregar subcampo
                </button>
              </div>
              <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                  <thead>
                    <tr>
                      <th>Tag</th>
                      <th>Código</th>
                      <th>Nombre</th>
                      <th>Repetibilidad</th>
                      <th>Obsoleto</th>
                      <th class="text-end">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let subcampo of campoSubcampos">
                      <td>{{ subcampo.tag }}</td>
                      <td>{{ subcampo.codigo }}</td>
                      <td>{{ subcampo.nombre }}</td>
                      <td>{{ subcampo.repetibilidad || 'NR' }}</td>
                      <td>{{ subcampo.esObsoleto ? 'Sí' : 'No' }}</td>
                      <td class="text-end">
                        <button class="btn btn-outline-primary btn-sm me-2" type="button"
                                (click)="editarSubcampo(subcampo)">
                          Editar
                        </button>
                        <button class="btn btn-outline-danger btn-sm" type="button"
                                (click)="eliminarSubcampo(subcampo)">
                          Eliminar
                        </button>
                      </td>
                    </tr>
                    <tr *ngIf="campoSubcampos.length === 0">
                      <td colspan="6" class="text-center text-muted">No se han cargado subcampos para este tag</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div *ngIf="campoEditing" class="mt-4">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <h6 class="m-0">Indicadores del tag {{ campoForm.tag }}</h6>
                <button class="btn btn-outline-success btn-sm" type="button"
                        (click)="nuevoIndicador(campoForm.formatoId, campoForm.tag)">
                  <i class="fa fa-plus-circle"></i> Agregar indicador
                </button>
              </div>
              <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                  <thead>
                    <tr>
                      <th>Tag</th>
                      <th>Posición</th>
                      <th>Valor</th>
                      <th>Significado</th>
                      <th class="text-end">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let indicador of campoIndicadores">
                      <td>{{ indicador.tag }}</td>
                      <td>{{ indicador.posicion }}</td>
                      <td>{{ indicador.valor }}</td>
                      <td>{{ indicador.significado }}</td>
                      <td class="text-end">
                        <button class="btn btn-outline-primary btn-sm me-2" type="button"
                                (click)="editarIndicador(indicador)">
                          Editar
                        </button>
                        <button class="btn btn-outline-danger btn-sm" type="button"
                                (click)="eliminarIndicador(indicador)">
                          Eliminar
                        </button>
                      </td>
                    </tr>
                    <tr *ngIf="campoIndicadores.length === 0">
                      <td colspan="5" class="text-center text-muted">No se han cargado indicadores para este tag</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="page-actions d-flex gap-2 mt-3">
              <button class="btn btn-success" type="button" (click)="guardarCampo()">Grabar</button>
              <button class="btn btn-outline-secondary" type="button" (click)="cancelarCampo()">Cancelar</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </section>

  <div class="modal-mask" *ngIf="subcampoFormVisible">
    <div class="modal-panel">
      <div class="modal-header">
        <h5 class="modal-title">{{ subcampoEditing ? 'Editar subcampo' : 'Nuevo subcampo' }}</h5>
        <button type="button" class="btn-close" aria-label="Cerrar" (click)="cancelarSubcampo()"></button>
      </div>
      <form #subcampoFormSection class="page-form">
        <div class="page-form-card mt-0">
          <div class="row g-3">
            <div class="col-12 col-md-4">
              <label class="form-label">Formato</label>
              <select class="form-select" [(ngModel)]="subcampoForm.formatoId" name="subcampoFormato">
                <option [ngValue]="0">Seleccione...</option>
                <option *ngFor="let formato of formatos" [ngValue]="formato.id">{{ formato.nombre }}</option>
              </select>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label">Tag</label>
              <input class="form-control" [(ngModel)]="subcampoForm.tag" name="subcampoTag" />
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label">Código</label>
              <input class="form-control" [(ngModel)]="subcampoForm.codigo" name="subcampoCodigo" />
            </div>
            <div class="col-12 col-md-5">
              <label class="form-label">Nombre</label>
              <input class="form-control" [(ngModel)]="subcampoForm.nombre" name="subcampoNombre" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Repetibilidad</label>
              <select class="form-select" [(ngModel)]="subcampoForm.repetibilidad" name="subcampoRepetibilidad">
                <option [ngValue]="undefined">NR (no repetible)</option>
                <option *ngFor="let opcion of repetibilidadOptions" [ngValue]="opcion">{{ opcion }}</option>
              </select>
            </div>
            <div class="col-12 col-md-3 d-flex align-items-center">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" [(ngModel)]="subcampoForm.esObsoleto" name="subcampoEsObsoleto" />
                <label class="form-check-label">Obsoleto</label>
              </div>
            </div>
          </div>
          <div class="page-actions d-flex gap-2 mt-3">
            <button class="btn btn-success" type="button" (click)="guardarSubcampo()">Grabar</button>
            <button class="btn btn-outline-secondary" type="button" (click)="cancelarSubcampo()">Cancelar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="modal-mask" *ngIf="indicadorFormVisible">
    <div class="modal-panel">
      <div class="modal-header">
        <h5 class="modal-title">{{ indicadorEditing ? 'Editar indicador' : 'Nuevo indicador' }}</h5>
        <button type="button" class="btn-close" aria-label="Cerrar" (click)="cancelarIndicador()"></button>
      </div>
      <form #indicadorFormSection class="page-form">
        <div class="page-form-card mt-0">
          <div class="row g-3">
            <div class="col-12 col-md-4">
              <label class="form-label">Formato</label>
              <select class="form-select" [(ngModel)]="indicadorForm.formatoId" name="indicadorFormato">
                <option [ngValue]="0">Seleccione...</option>
                <option *ngFor="let formato of formatos" [ngValue]="formato.id">{{ formato.nombre }}</option>
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Tag</label>
              <input class="form-control" [(ngModel)]="indicadorForm.tag" name="indicadorTag" />
            </div>
            <div class="col-12 col-md-2">
              <label class="form-label">Posición</label>
              <select class="form-select" [(ngModel)]="indicadorForm.posicion" name="indicadorPosicion">
                <option [ngValue]="1">1</option>
                <option [ngValue]="2">2</option>
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Valor</label>
              <input class="form-control" [(ngModel)]="indicadorForm.valor" name="indicadorValor" />
            </div>
            <div class="col-12">
              <label class="form-label">Significado</label>
              <textarea class="form-control" rows="2" [(ngModel)]="indicadorForm.significado" name="indicadorSignificado"></textarea>
            </div>
          </div>
          <div class="page-actions d-flex gap-2 mt-3">
            <button class="btn btn-success" type="button" (click)="guardarIndicador()">Grabar</button>
            <button class="btn btn-outline-secondary" type="button" (click)="cancelarIndicador()">Cancelar</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
